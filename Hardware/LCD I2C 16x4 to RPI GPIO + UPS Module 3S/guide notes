
This is the complete, step-by-step guide to setting up your Raspberry Pi 5 with the Hailo-8 AI HAT, Waveshare UPS 3S, and the 16x4 I2C LCD.


Phase1: Hardware Wiring
Since you are powering the Pi 5 via USB-C from the UPS, follow this specific wiring map to share the data lines (I2C) safely.
Signal	Raspberry Pi 5 Pin	Connect to UPS Header	Connect to LCD (PCF8574)
5V Power	Pin 2 or 4	DO NOT CONNECT	VCC
Ground	Pin 6	GND (Pin 5/6)	GND
I2C SDA	Pin 3	SDA (Pin 2)	SDA
I2C SCL	Pin 5	SCL (Pin 1)	SCL

Note: The UPS and LCD "share" Pins 3, 5, and 6. Twist the wires together or use your 1-to-3 expansion board to merge them.


Phase 2: System Configuration
Before writing code, you must enable the I2C "communication highway" on the Raspberry Pi 5.
1.Open the terminal and run:sudo raspi-config
2.Navigate to Interface Options > I2C > Yes.
3.Select Finish and Reboot if prompted.


Phase 3: Software Installation
On Raspberry Pi 5 (Bookworm OS), we must use the --break-system-packages flag to install Python libraries globally.
Run these commands in order:
# Update system
sudo apt update

# Install I2C tools and Python headers
sudo apt install python3-smbus i2c-tools python3-pip -y

# Install the required Python libraries
pip install psutil RPLCD smbus2 --break-system-packages


Phase 4: Verify Hardware Connection
Check if the Pi can "see" both the UPS and the LCD. Run:
i2cdetect -y 1

You should see 41 (the UPS) and 27 (or 3F for the LCD). If you don't see these numbers, check your wiring.


Phase 5: The Finalized Python Script
This script includes the accurate memory formula (Used/Total) to match your Task Manager and the 16x4 formatting.
Create the file: smart_monitor.py
Paste the following code:

____________________________________________________________________
import smbus2 as smbus
import time
import psutil
from RPLCD.i2c import CharLCD

# ==========================================
# CONFIGURATION
# ==========================================
I2C_BUS = 1
UPS_ADDR = 0x41 
LCD_ADDR = 0x27 
LCD_COLS = 16
LCD_ROWS = 4

# Initialize LCD
lcd = CharLCD('PCF8574', LCD_ADDR, port=1, cols=LCD_COLS, rows=LCD_ROWS)

class INA219:
    def __init__(self, addr):
        self.bus = smbus.SMBus(I2C_BUS)
        self.addr = addr
        self.calibrate()

    def calibrate(self):
        # 32V / 2A Calibration from your SmartUPS code
        try:
            self.bus.write_i2c_block_data(self.addr, 0x05, [0x10, 0x00])
            self.bus.write_i2c_block_data(self.addr, 0x00, [0x39, 0x9F])
        except: pass

    def get_voltage(self):
        try:
            data = self.bus.read_i2c_block_data(self.addr, 0x02, 2)
            raw = (data[0] << 8) | data[1]
            return (raw >> 3) * 0.004
        except: return 0.0

def get_cpu_temp():
    try:
        with open("/sys/class/thermal/thermal_zone0/temp", "r") as f:
            return float(f.read()) / 1000.0
    except: return 0.0

# ==========================================
# ACCURATE MEMORY CALCULATION
# ==========================================
def get_accurate_mem_percent():
    mem = psutil.virtual_memory()
    # Task Manager Style: (Used / Total) * 100
    # This ignores Buffers/Cache to give you the "App Usage" percentage
    used_mb = mem.used / (1024**2)
    total_mb = mem.total / (1024**2)
    percentage = (mem.used / mem.total) * 100
    return percentage, used_mb

# ==========================================
# MAIN LOOP
# ==========================================
ups = INA219(UPS_ADDR)

try:
    while True:
        # 1. Gather Metrics
        v = ups.get_voltage()
        cpu_t = get_cpu_temp()
        cpu_u = psutil.cpu_percent()
        mem_p, mem_used = get_accurate_mem_percent()
        
        # 2. Battery % (9V-12.6V Logic)
        batt_p = min(max(((v - 9.0) / 3.6) * 100, 0), 100)

        # 3. Format Strings for 16-Char LCD
        # Line 1: Battery
        line1 = f"BATTERY :{batt_p:5.1f}%".ljust(16)
        # Line 2: Temp
        line2 = f"CPU TEMP:{cpu_t:5.1f}C".ljust(16)
        # Line 3: Accurate Memory (Formula: Used/Total)
        line4 = f"RAM USE  :{mem_p:5.1f}%".ljust(16)
        # Line 4: CPU Usage
        line3 = f"CPU USE :{cpu_u:5.1f}%".ljust(16)

        # 4. Push to LCD
        lcd.cursor_pos = (0, 0); lcd.write_string(line1)
        lcd.cursor_pos = (1, 0); lcd.write_string(line2)
        lcd.cursor_pos = (2, 0); lcd.write_string(line3)
        lcd.cursor_pos = (3, 0); lcd.write_string(line4)

        time.sleep(2)

except KeyboardInterrupt:
    lcd.clear()
    lcd.write_string("Monitor Stopped")
____________________________________________________________________
#. Press Ctrl+X, then Y, then Enter to save.


Phase 6: Run and Auto-Start

Since you have confirmed your username is raspberrypi and your script is working manually, here is the complete, finalized step-by-step guide to making it run automatically every time your Raspberry Pi 5 boots.


Step 1: Prepare the Script File
Ensure your script is saved in your home folder and has the correct name.
1.Open your terminal.[1]
2.Save your working code into a file:
nano /home/raspberrypi/smart_monitor.py

3.Paste your code, save (Ctrl+O, Enter), and exit (Ctrl+X).
4.Make it executable: This ensures the system has permission to run the file.
chmod +x /home/raspberrypi/smart_monitor.py


Step 2: Create the Systemd Service File
This is the "instruction manual" that tells the Pi to start your script at boot.
1. Create the service file:
sudo nano /etc/systemd/system/lcd_monitor.service

2.Paste this exact configuration:
Unit]
Description=Raspberry Pi 5 LCD Monitor
After=multi-user.target

[Service]
# Changed from 'pi' to 'raspberrypi'
User=raspberrypi
WorkingDirectory=/home/raspberrypi
# Ensure the filename here matches what you named your python file
ExecStart=/usr/bin/python3 /home/raspberrypi/smart_monitor.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target


3.Save and Exit: Press Ctrl+O, then Enter, then Ctrl+X.


Step 4: Fix Permissions for the I2C Bus
The service needs permission to talk to the SDA/SCL pins without you being logged in.
sudo usermod -a -G i2c raspberrypi


Step 5: "The Activation" (Compile/Register)
This is the process to tell the Pi to load your new configuration.

1.Reload the system daemon:
sudo systemctl daemon-reload

2.Enable the service (This sets it to run on BOOT):
sudo systemctl enable lcd_monitor.service

3.Start the service (This runs it NOW):
sudo systemctl start lcd_monitor.service


Step 6: Verify it is working
Check the status to ensure it says Active (running) in green text:
sudo systemctl status lcd_monitor.service

If you see errors:
If it still won't start, run this to see the live Python error log:
journalctl -u lcd_monitor.service -f



Summary Checklist for Success:
Path: Your script is definitely at /home/raspberrypi/smart_monitor.py.
# Username: Every mention of pi has been changed to raspberrypi.
# Libraries: You used --break-system-packages so the service can find RPLCD.
# Hardware: Your Waveshare UPS and LCD are connected to the GPIO.

- Now, when you flip the UPS battery switch, the Pi 5 will boot and your LCD will automatically turn on with your Battery and CPU stats within 15-20 seconds!


